<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë¥˜ë¼ì´ íŒ¬ì‚¬ì´íŠ¸</title>
<style>
  /* ê³µí†µ ìŠ¤íƒ€ì¼ */
  body {
    margin: 0; padding: 0;
    font-family: 'Noto Sans KR', sans-serif;
    background: #fff0f6;
    color: #333;
  }
  header {
    background: #ff4d6d;
    color: white;
    padding: 15px 20px;
    text-align: center;
    font-weight: 700;
    font-size: 1.5rem;
    user-select: none;
  }
  #main-content {
    padding: 15px;
    min-height: 60vh;
  }
  #tab-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #ff4d6d;
    display: flex;
    justify-content: space-around;
    padding: 8px 0;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    box-shadow: 0 -3px 8px rgb(255 77 109 / 0.4);
    user-select: none;
  }
  #tab-bar button {
    border: none;
    background: transparent;
    color: #ffe6ed;
    font-size: 1.2rem;
    cursor: pointer;
    flex-grow: 1;
    font-weight: 700;
    padding: 5px 0;
  }
  #tab-bar button.active {
    color: white;
    border-bottom: 3px solid #ffe6ed;
  }
  input, textarea, select, button {
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 1rem;
  }
  textarea {
    width: 100%;
    resize: vertical;
    border-radius: 8px;
    border: 1px solid #ccc;
    padding: 10px;
    box-sizing: border-box;
  }
  input[type="text"], input[type="password"], select {
    width: 100%;
    box-sizing: border-box;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button.primary {
    background: #ff4d6d;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button.primary:hover {
    background: #e44362;
  }
  button.danger {
    background: #f44336;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
  }
  .letter, .user-item, .suggestion-item {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgb(255 77 109 / 0.3);
    padding: 10px 14px;
    margin-bottom: 10px;
  }
  .letter small, .suggestion-item small, .user-item small {
    color: #999;
  }
  .actions {
    margin-top: 6px;
  }
  .actions button {
    margin-right: 6px;
  }
  .user-item span.role {
    font-weight: 700;
    color: #ff4d6d;
  }
  #profile-img-preview {
    display: block;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
    border: 2px solid #ff4d6d;
  }
  #qrcode-container canvas {
    margin-top: 10px;
  }
  .mini-game-box {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 12px rgb(255 77 109 / 0.3);
  }
  .mini-game-box button {
    margin-top: 12px;
  }
</style>
</head>
<body>

<header>ë¥˜ë¼ì´ íŒ¬ì‚¬ì´íŠ¸</header>
<div id="main-content">
  <!-- ë¡œê·¸ì¸ í¼ ë˜ëŠ” ë©”ì¸ ì»¨í…ì¸ ê°€ ì—¬ê¸° ë Œë”ë¨ -->
</div>

<div id="tab-bar" style="display:none;">
  <button data-tab="profile" id="tab-profile">í”„ë¡œí•„</button>
  <button data-tab="home" id="tab-home">í™ˆ</button>
  <button data-tab="fan" id="tab-fan">íŒ¬</button>
  <button data-tab="suggestion" id="tab-suggestion">ê±´ì˜</button>
  <button data-tab="shop" id="tab-shop">ìƒì </button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<!-- QRCode -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
  // Firebase ì´ˆê¸°í™” (ë³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì •ì— ë§ê²Œ ìˆ˜ì •)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  const mainContent = document.getElementById("main-content");
  const tabBar = document.getElementById("tab-bar");

  let currentUser = null;
  let currentUserData = null;

  // ê¸°ë³¸ ì—­í•  ì§€ì •
  const ROLES = {
    MEMBER: "member",
    ADMIN: "admin",
    MANAGER: "manager"
  };

  // ìœ í‹¸ - ë‚ ì§œ í¬ë§·
  function formatDate(timestamp) {
    if (!timestamp) return "";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleString("ko-KR", { hour12: false });
  }

  // ë¡œê·¸ì¸ í™”ë©´ ë Œë”ë§
  function renderLogin() {
    tabBar.style.display = "none";
    mainContent.innerHTML = `
      <h2>ë¡œê·¸ì¸ ë˜ëŠ” íšŒì›ê°€ì…</h2>
      <input type="email" id="input-email" placeholder="ì´ë©”ì¼" autocomplete="username" />
      <input type="password" id="input-password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
      <button id="btn-login" class="primary">ë¡œê·¸ì¸</button>
      <button id="btn-register" class="primary" style="margin-left:10px;">íšŒì›ê°€ì…</button>
      <p id="login-msg" style="color:red;"></p>
    `;

    document.getElementById("btn-login").onclick = async () => {
      const email = document.getElementById("input-email").value.trim();
      const password = document.getElementById("input-password").value.trim();
      if (!email || !password) {
        document.getElementById("login-msg").textContent = "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (e) {
        document.getElementById("login-msg").textContent = e.message;
      }
    };

    document.getElementById("btn-register").onclick = async () => {
      const email = document.getElementById("input-email").value.trim();
      const password = document.getElementById("input-password").value.trim();
      if (!email || !password) {
        document.getElementById("login-msg").textContent = "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
        return;
      }
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        // ì‹ ê·œê°€ì… ì‹œ ê¸°ë³¸ member ì—­í•  ë¶€ì—¬ ë° ê¸°ë³¸ ë‹‰ë„¤ì„ ì„¤ì •
        await db.collection("users").doc(cred.user.uid).set({
          email,
          nickname: "ë¬´ëª…",
          intro: "",
          role: ROLES.MEMBER,
          strawberryPoints: 10000,  // ì‹ ê·œ ê°€ì… ë³´ë„ˆìŠ¤ ë”¸ê¸°í¬ì¸íŠ¸
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) {
        document.getElementById("login-msg").textContent = e.message;
      }
    };
  }

  // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
  function logout() {
    auth.signOut();
  }

  // í˜„ì¬ ìœ ì € ë°ì´í„° ìµœì‹ í™”
  async function fetchCurrentUserData(uid) {
    try {
      const doc = await db.collection("users").doc(uid).get();
      if (doc.exists) return doc.data();
      return null;
    } catch {
      return null;
    }
  }

  // ë©”ì¸ ë Œë”ë§: ë¡œê·¸ì¸ í›„ ë©”ì¸ UI + íƒ­ë°” ë³´ì„
  async function renderMain() {
    tabBar.style.display = "flex";
    renderTab("home");
  }

  // íƒ­ë³„ ë Œë” í•¨ìˆ˜
  async function renderTab(tabName) {
    clearActiveTab();
    const btn = document.querySelector(`#tab-bar button[data-tab="${tabName}"]`);
    if (btn) btn.classList.add("active");

    switch(tabName) {
      case "profile": await renderProfileTab(); break;
      case "home": renderHomeTab(); break;
      case "fan": await renderFanTab(); break;
      case "suggestion": await renderSuggestionTab(); break;
      case "shop": await renderShopTab(); break;
    }
  }
  function clearActiveTab() {
    const buttons = document.querySelectorAll("#tab-bar button");
    buttons.forEach(btn => btn.classList.remove("active"));
  }

  // ================== í”„ë¡œí•„ íƒ­ ==================
  async function renderProfileTab() {
    const userDoc = await db.collection("users").doc(currentUser.uid).get();
    currentUserData = userDoc.data();

    mainContent.innerHTML = `
      <h2>í”„ë¡œí•„</h2>
      <img id="profile-img-preview" src="${currentUserData.photoURL || 'https://via.placeholder.com/100?text=í”„ë¡œí•„'}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" />
      <input type="file" id="profile-img-upload" accept="image/*" />
      <br />
      <label>ë‹‰ë„¤ì„:</label>
      <input type="text" id="profile-nickname" value="${escapeHtml(currentUserData.nickname || "")}" />
      <label>ì†Œê°œê¸€:</label>
      <textarea id="profile-intro" rows="3">${escapeHtml(currentUserData.intro || "")}</textarea>
      <button id="save-profile-btn" class="primary">ì €ì¥í•˜ê¸°</button>
      <button id="logout-btn" class="danger" style="margin-top: 10px;">ë¡œê·¸ì•„ì›ƒ</button>
      <hr />
      <h3>í”„ë¡œí•„ QR ì½”ë“œ</h3>
      <div id="qrcode-container"></div>
    `;

    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
    const imgInput = document.getElementById("profile-img-upload");
    const imgPreview = document.getElementById("profile-img-preview");

    imgInput.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }
      // ë¯¸ë¦¬ë³´ê¸°
      const reader = new FileReader();
      reader.onload = e => {
        imgPreview.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };

    document.getElementById("save-profile-btn").onclick = async () => {
      const nickname = document.getElementById("profile-nickname").value.trim();
      const intro = document.getElementById("profile-intro").value.trim();
      if (!nickname) {
        alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      // ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ì„ íƒë˜ì—ˆìœ¼ë©´ ìŠ¤í† ë¦¬ì§€ì— ì—…ë¡œë“œ
      let photoURL = currentUserData.photoURL || null;
      if (imgInput.files[0]) {
        try {
          const file = imgInput.files[0];
          const ref = storage.ref().child(`profile_images/${currentUser.uid}_${Date.now()}`);
          await ref.put(file);
          photoURL = await ref.getDownloadURL();
        } catch(e) {
          alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message);
          return;
        }
      }
      try {
        await db.collection("users").doc(currentUser.uid).update({
          nickname,
          intro,
          photoURL,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        currentUserData.nickname = nickname;
        currentUserData.intro = intro;
        currentUserData.photoURL = photoURL;
        renderProfileTab(); // ê°±ì‹ 
      } catch(e) {
        alert("í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨: " + e.message);
      }
    };

    document.getElementById("logout-btn").onclick = () => {
      logout();
    };

    // QRì½”ë“œ ìƒì„± (ë‹‰ë„¤ì„ + ì´ë©”ì¼)
    const qrcodeContainer = document.getElementById("qrcode-container");
    qrcodeContainer.innerHTML = "";
    const qrcodeText = `ë¥˜ë¼ì´ íŒ¬ì‚¬ì´íŠ¸\në‹‰ë„¤ì„: ${currentUserData.nickname}\nì´ë©”ì¼: ${currentUser.email}`;
    QRCode.toCanvas(qrcodeText, { width: 150 }, (error, canvas) => {
      if (error) console.error(error);
      else qrcodeContainer.appendChild(canvas);
    });
  }

  // ================== í™ˆ íƒ­ ==================
  function renderHomeTab() {
    mainContent.innerHTML = `
      <h2>í™ˆ</h2>
      <p>ë¥˜ë¼ì´ íŒ¬ì‚¬ì´íŠ¸ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤! íŒ¬í™œë™, ê²Œì„, ì¸í„°ë·° ë“± ë‹¤ì–‘í•œ ì»¨í…ì¸ ë¥¼ ì¦ê²¨ë³´ì„¸ìš”.</p>
      <hr />
      <div class="mini-game-box">
        <h3>ë¯¸ë‹ˆ ê²Œì„: ìˆ«ì ë§ì¶”ê¸°</h3>
        <p>1~10 ì‚¬ì´ ìˆ«ì ì¤‘ í•˜ë‚˜ë¥¼ ë§ì¶°ë³´ì„¸ìš”!</p>
        <input type="number" id="guess-input" min="1" max="10" />
        <button id="guess-btn" class="primary">ë§ì¶°ë³´ê¸°</button>
        <p id="guess-result"></p>
      </div>
      <hr />
      <div>
        <h3>ë¥˜ë¼ì´ ì¸í„°ë·°</h3>
        <div id="interview-container">
          <p><em>ì•„ì§ ì¸í„°ë·° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ì¶”í›„ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤.</em></p>
        </div>
      </div>
    `;

    // ë¯¸ë‹ˆê²Œì„ ë¡œì§
    const answer = Math.floor(Math.random() * 10) + 1;
    const guessInput = document.getElementById("guess-input");
    const guessBtn = document.getElementById("guess-btn");
    const guessResult = document.getElementById("guess-result");

    guessBtn.onclick = () => {
      const guess = Number(guessInput.value);
      if (!guess || guess < 1 || guess > 10) {
        guessResult.textContent = "1ë¶€í„° 10 ì‚¬ì´ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        guessResult.style.color = "red";
        return;
      }
      if (guess === answer) {
        guessResult.textContent = "ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰";
        guessResult.style.color = "green";
      } else if (guess < answer) {
        guessResult.textContent = "ë” í° ìˆ˜ì…ë‹ˆë‹¤!";
        guessResult.style.color = "blue";
      } else {
        guessResult.textContent = "ë” ì‘ì€ ìˆ˜ì…ë‹ˆë‹¤!";
        guessResult.style.color = "blue";
      }
    };
  }

  // ================== íŒ¬ íƒ­ ==================
  async function renderFanTab() {
    mainContent.innerHTML = `
      <h2>íŒ¬</h2>
      <p>íŒ¬ë“¤ë¼ë¦¬ ì†Œí†µí•˜ê³  í¸ì§€ë¥¼ ì£¼ê³ ë°›ëŠ” ê³µê°„ì…ë‹ˆë‹¤.</p>
      <hr />
      <form id="fan-letter-form">
        <label for="letter-text">í¸ì§€ ì‘ì„±</label><br/>
        <textarea id="letter-text" rows="4" placeholder="ë¥˜ë¼ì´ì—ê²Œ í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì„¸ìš”."></textarea><br/>
        <button type="submit" class="primary">í¸ì§€ ë³´ë‚´ê¸°</button>
      </form>
      <hr />
      <h3>ë°›ì€ í¸ì§€</h3>
      <div id="fan-letter-list">ë¡œë”© ì¤‘...</div>
    `;

    const letterForm = document.getElementById("fan-letter-form");
    const letterList = document.getElementById("fan-letter-list");

    // í¸ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadLetters() {
      db.collection("letters")
        .orderBy("createdAt", "desc")
        .limit(20)
        .onSnapshot(snapshot => {
          if (snapshot.empty) {
            letterList.innerHTML = "<p>ë°›ì€ í¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
          }
          letterList.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "letter";
            div.innerHTML = `
              <p>${escapeHtml(data.text)}</p>
              <small>ì‘ì„±ì: ${escapeHtml(data.nickname || "ìµëª…")} | ${formatDate(data.createdAt)}</small>
            `;

            // ê´€ë¦¬ì ë° ì‘ì„±ìì—ê²Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            if (canDeleteLetter(doc.id, data)) {
              const delBtn = document.createElement("button");
              delBtn.textContent = "ì‚­ì œ";
              delBtn.className = "danger";
              delBtn.style.marginLeft = "10px";
              delBtn.onclick = () => {
                if (confirm("ì´ í¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                  db.collection("letters").doc(doc.id).delete();
                }
              };
              div.querySelector("small").appendChild(delBtn);
            }
            letterList.appendChild(div);
          });
        });
    }
    loadLetters();

    // í¸ì§€ ì‘ì„± ì´ë²¤íŠ¸
    letterForm.onsubmit = async (e) => {
      e.preventDefault();
      const text = document.getElementById("letter-text").value.trim();
      if (!text) {
        alert("í¸ì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      try {
        await db.collection("letters").add({
          text,
          userId: currentUser.uid,
          nickname: currentUserData.nickname,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        letterForm.reset();
        alert("í¸ì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.");
      } catch(e) {
        alert("í¸ì§€ ì „ì†¡ ì‹¤íŒ¨: " + e.message);
      }
    };
  }

  // ================== ê±´ì˜ íƒ­ ==================
  async function renderSuggestionTab() {
    mainContent.innerHTML = `
      <h2>ê±´ì˜ì‚¬í•­</h2>
      <p>ì‚¬ì´íŠ¸ ê´€ë ¨ ê±´ì˜ë‚˜ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
      <hr />
      <form id="suggestion-form">
        <label for="suggestion-text">ê±´ì˜ ë‚´ìš©</label><br/>
        <textarea id="suggestion-text" rows="4" placeholder="ê±´ì˜ì‚¬í•­ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”."></textarea><br/>
        <button type="submit" class="primary">ê±´ì˜ ë³´ë‚´ê¸°</button>
      </form>
      <hr />
      <h3>ê±´ì˜ ëª©ë¡</h3>
      <div id="suggestion-list">ë¡œë”© ì¤‘...</div>
    `;

    const suggestionForm = document.getElementById("suggestion-form");
    const suggestionList = document.getElementById("suggestion-list");

    function loadSuggestions() {
      db.collection("suggestions")
        .orderBy("createdAt", "desc")
        .limit(20)
        .onSnapshot(snapshot => {
          if (snapshot.empty) {
            suggestionList.innerHTML = "<p>ê±´ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
          }
          suggestionList.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "suggestion-item";
            div.innerHTML = `
              <p>${escapeHtml(data.text)}</p>
              <small>ì‘ì„±ì: ${escapeHtml(data.nickname || "ìµëª…")} | ${formatDate(data.createdAt)}</small>
            `;

            // ê´€ë¦¬ìë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            if (isAdminOrManager()) {
              const delBtn = document.createElement("button");
              delBtn.textContent = "ì‚­ì œ";
              delBtn.className = "danger";
              delBtn.style.marginLeft = "10px";
              delBtn.onclick = () => {
                if (confirm("ì´ ê±´ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                  db.collection("suggestions").doc(doc.id).delete();
                }
              };
              div.querySelector("small").appendChild(delBtn);
            }

            suggestionList.appendChild(div);
          });
        });
    }
    loadSuggestions();

    suggestionForm.onsubmit = async (e) => {
      e.preventDefault();
      const text = document.getElementById("suggestion-text").value.trim();
      if (!text) {
        alert("ê±´ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      try {
        await db.collection("suggestions").add({
          text,
          userId: currentUser.uid,
          nickname: currentUserData.nickname,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        suggestionForm.reset();
        alert("ê±´ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } catch(e) {
        alert("ê±´ì˜ ì „ì†¡ ì‹¤íŒ¨: " + e.message);
      }
    };
  }

  // ================== ìƒì  íƒ­ ==================
  async function renderShopTab() {
    // ì„ì‹œ ìƒì  ì•„ì´í…œ ëª©ë¡ (ì‹¤ì œë¡œëŠ” Firestoreì—ì„œ ê´€ë¦¬ ê°€ëŠ¥)
    const items = [
      { id: "item1", name: "ë¥˜ë¼ì´ ìŠ¤í‹°ì»¤", price: 1000, description: "ê·€ì—¬ìš´ ë¥˜ë¼ì´ ìŠ¤í‹°ì»¤ì…ë‹ˆë‹¤." },
      { id: "item2", name: "ë¥˜ë¼ì´ ë°°ì§€", price: 3000, description: "íŒ¬ì‹¬ ê°€ë“ ë°°ì§€!" },
      { id: "item3", name: "í¬í† ì¹´ë“œ ëœë¤íŒ©", price: 5000, description: "í•œì •íŒ í¬í† ì¹´ë“œ ëœë¤íŒ©ì…ë‹ˆë‹¤." }
    ];

    mainContent.innerHTML = `
      <h2>ìƒì </h2>
      <p>ë”¸ê¸°í¬ì¸íŠ¸ë¡œ ì•„ì´í…œì„ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <p>í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸: <span id="point-display">${currentUserData.strawberryPoints || 0}</span> ë”¸ê¸°í¬ì¸íŠ¸</p>
      <hr />
      <div id="shop-item-list"></div>
    `;

    const shopItemList = document.getElementById("shop-item-list");

    items.forEach(item => {
      const div = document.createElement("div");
      div.className = "letter";
      div.innerHTML = `
        <h4>${item.name} - ${item.price} ë”¸ê¸°í¬ì¸íŠ¸</h4>
        <p>${escapeHtml(item.description)}</p>
        <button class="primary buy-btn" data-id="${item.id}">êµ¬ë§¤í•˜ê¸°</button>
      `;
      shopItemList.appendChild(div);
    });

    // êµ¬ë§¤ ì²˜ë¦¬
    document.querySelectorAll(".buy-btn").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-id");
        const item = items.find(i => i.id === id);
        if (!item) {
          alert("ì•„ì´í…œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        if ((currentUserData.strawberryPoints || 0) < item.price) {
          alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          return;
        }
        if (!confirm(`${item.name}ì„(ë¥¼) ${item.price} ë”¸ê¸°í¬ì¸íŠ¸ë¡œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try {
          // í¬ì¸íŠ¸ ì°¨ê° ë° êµ¬ë§¤ ë‚´ì—­ ì €ì¥(ì„ì‹œë¡œ ë¡œì»¬ì—ë§Œ ì €ì¥)
          currentUserData.strawberryPoints -= item.price;
          document.getElementById("point-display").textContent = currentUserData.strawberryPoints;
          alert(`${item.name}ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!`);
          // ì‹¤ì œ êµ¬í˜„ ì‹œ Firestore ì—…ë°ì´íŠ¸ í•„ìš”
        } catch(e) {
          alert("êµ¬ë§¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
        }
      };
    });
  }

  // ================== ìœ í‹¸ í•¨ìˆ˜ ==================
  function escapeHtml(text) {
    if (!text) return "";
    return text.replace(/&/g, "&amp;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;")
               .replace(/"/g, "&quot;")
               .replace(/'/g, "&#039;");
  }

  function formatDate(timestamp) {
    if (!timestamp) return "";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,"0")}-${date.getDate().toString().padStart(2,"0")} ${date.getHours().toString().padStart(2,"0")}:${date.getMinutes().toString().padStart(2,"0")}`;
  }

  // ê¶Œí•œ ì²´í¬ í•¨ìˆ˜
  function isAdminOrManager() {
    return currentUserData.role === "manager" || currentUserData.role === "admin";
  }

  function canDeleteLetter(letterId, letterData) {
    if (!currentUser) return false;
    if (currentUserData.role === "manager") return true;
    if (currentUserData.role === "admin") return true;
    if (letterData.userId === currentUser.uid) return true;
    return false;
  }

  // ================== ì´ˆê¸°í™” ==================
  // ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ ì‹œ í”„ë¡œí•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ì´ˆê¸°í™”
  firebase.auth().onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      // í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ
      const doc = await db.collection("users").doc(user.uid).get();
      if (doc.exists) {
        currentUserData = doc.data();
      } else {
        // ì‹ ê·œ ìœ ì € ê¸°ë³¸ ë°ì´í„° ìƒì„±
        currentUserData = {
          role: "member",
          nickname: "",
          intro: "",
          photoURL: null,
          strawberryPoints: 0
        };
        await db.collection("users").doc(user.uid).set(currentUserData);
      }
      renderApp();
    } else {
      renderLogin();
    }
  });

})();
</script>

</body>
</html>
